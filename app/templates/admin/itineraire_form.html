{% extends "base.html" %}
{% block title %}Ajouter un itinéraire{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/itineraire_form.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin=""/>

<div class="itineraire-form-wrapper">
    <h2>Ajouter un itinéraire
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 9l6 6"/><path d="M15 9l-6 6"/></svg>
    </h2>
    <form method="POST" id="itineraireForm">
        {{ form.hidden_tag() }}

        <div class="form-group">
            {{ form.date_trajet.label(class="form-label") }}
            {{ form.date_trajet(class="form-control", placeholder="Date du trajet") }}
        </div>
        <div class="form-group">
            {{ form.lieu_depart.label(class="form-label") }}
            {{ form.lieu_depart(class="form-control", id="lieu_depart", placeholder="Lieu de départ") }}
        </div>
        <div class="form-group">
            {{ form.lieu_arrivee.label(class="form-label") }}
            {{ form.lieu_arrivee(class="form-control", id="lieu_arrivee", placeholder="Lieu d'arrivée") }}
        </div>
        <div class="form-group">
            {{ form.distance_km.label(class="form-label") }}
            {{ form.distance_km(class="form-control", id="distance_km", placeholder="Distance (km)") }}
        </div>
        <div class="form-group">
            {{ form.duree_minutes.label(class="form-label") }}
            {{ form.duree_minutes(class="form-control", id="duree_minutes", placeholder="Durée (minutes)") }}
        </div>
        {{ form.polyline(type="hidden", id="polyline") }}

        <div class="form-group">
            <label class="form-label">Tracer l'itinéraire sur la carte</label>
            <div id="map" style="height: 350px; border-radius: 14px; margin-bottom: 1.2rem;"></div>
            <div class="map-instructions">
                <span>Cliquer sur la carte pour définir le départ (vert) et l'arrivée (rouge). Le trajet sera tracé automatiquement.</span>
            </div>
        </div>

        <div class="form-nav-btns">
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">Annuler</a>
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>
</div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
<script>
let map = L.map('map').setView([14.6928, -17.4467], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = [];
let polyline = null;

function updatePolyline() {
    if (polyline) map.removeLayer(polyline);
    if (markers.length === 2) {
        // Appel à l'API OSRM pour le routage
        const url = `https://router.project-osrm.org/route/v1/driving/${markers[0].getLatLng().lng},${markers[0].getLatLng().lat};${markers[1].getLatLng().lng},${markers[1].getLatLng().lat}?overview=full&geometries=geojson`;
        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.routes && data.routes.length) {
                    const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    polyline = L.polyline(coords, {color: '#a992f7', weight: 5}).addTo(map);
                    map.fitBounds(polyline.getBounds(), {padding: [40, 40]});
                    // Remplir les champs distance/durée/polyline
                    document.getElementById('distance_km').value = (data.routes[0].distance/1000).toFixed(2);
                    document.getElementById('duree_minutes').value = Math.round(data.routes[0].duration/60);
                    document.getElementById('polyline').value = JSON.stringify(coords);
                }
            });
    }
}

map.on('click', function(e) {
    if (markers.length >= 2) {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        if (polyline) { map.removeLayer(polyline); polyline = null; }
        document.getElementById('polyline').value = '';
        document.getElementById('distance_km').value = '';
        document.getElementById('duree_minutes').value = '';
    }
    let color = markers.length === 0 ? "#3fd18b" : "#e74c3c";
    let marker = L.circleMarker(e.latlng, {radius: 8, color: color, fillColor: color, fillOpacity: 1}).addTo(map);
    markers.push(marker);
    if (markers.length === 1) {
        document.getElementById('lieu_depart').value = `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
    } else if (markers.length === 2) {
        document.getElementById('lieu_arrivee').value = `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
        updatePolyline();
    }
});
</script>
{% endblock %}